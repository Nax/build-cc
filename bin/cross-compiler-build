#!/usr/bin/env bash

core_count=$(getconf _NPROCESSORS_ONLN)
thread_count=$(($core_count + $core_count / 2))

prefix="/opt/cross"
efi=false
languages=c,c++
targets=""

binutils_version=2.26
mpfr_version=3.1.4
gmp_version=6.1.0
mpc_version=1.0.3
gcc_version=6.1.0

script="$0"
params="$@"

# Parse options
while [ ! -z "$1" ]; do
  case "$1" in
    --efi|-E)
      efi=true ;;
    --prefix|-P)
      shift
      if [ -z "$1" ]; then
        echo "--prefix should be followed by a value"
        exit 1
      fi
      prefix="$1" ;;
    --languages|-L)
      shift
      if [ -z "$1" ]; then
        echo "--languages should be followed by a value"
        exit 1
      fi
      languages="$1" ;;
    *)
      targets="$targets $1" ;;
  esac
  shift
done

if [ -z "$targets" ]; then
  echo "usage: cross-compiler-build [--prefix prefix] [--languages languages] [--efi] target [target...]"
  echo
  echo
  echo "About the options:"
  echo
  echo "--efi                     Inject PE targets into binutils, making the toolset suitable for (U)EFI development"
  echo "--prefix <prefix>         Install the cross-compiler inside the specified directory. Defaults to /opt/cross"
  echo "--languages <languages>   A list of comma separated languages that the toolset will support. Defaults to c,c++"
  echo 
  echo
  echo "About this script:"
  echo "    This script was created by Nax."
  echo "    This is Free Software, published under the GNU General Public License version 2 (GPLv2)"
  exit
fi

# Check if root is needed to install at the required prefix.
# If that's the case, reload the script as root.
if ! mkdir -p "$prefix" > /dev/null 2>&1 || [ ! -w "$prefix" ]; then
  exec sudo -- "$script" $params
fi

cd /tmp
tmpdir=$(mktemp -d "cross-compiler-XXXXXXXXXX")
cd $tmpdir

echo "Downloading binutils"
curl -#L "https://ftp.gnu.org/gnu/binutils/binutils-$binutils_version.tar.bz2" -o binutils.tar.bz2
mkdir -p binutils
tar xjf binutils.tar.bz2 -C binutils --strip=1
echo

echo "Downloading gcc"
curl -#L "https://ftp.gnu.org/gnu/gcc/gcc-$gcc_version/gcc-$gcc_version.tar.bz2" -o gcc.tar.bz2
mkdir -p gcc
tar xjf gcc.tar.bz2 -C gcc --strip=1
echo

echo "Downloading mpfr"
curl -#L "https://ftp.gnu.org/gnu/mpfr/mpfr-$mpfr_version.tar.bz2" -o mpfr.tar.bz2
mkdir -p gcc/mpfr
tar xjf mpfr.tar.bz2 -C gcc/mpfr --strip=1
echo

echo "Downloading gmp"
curl -#L "https://ftp.gnu.org/gnu/gmp/gmp-$gmp_version.tar.bz2" -o gmp.tar.bz2
mkdir -p gcc/gmp
tar xjf gmp.tar.bz2 -C gcc/gmp --strip=1
echo

echo "Downloading mpc"
curl -#L "https://ftp.gnu.org/gnu/mpc/mpc-$mpc_version.tar.gz" -o mpc.tar.gz
mkdir -p gcc/mpc
tar xzf mpc.tar.gz -C gcc/mpc --strip=1
echo

for target in $targets; do
  cd binutils
  binutils_conf=""
  if $efi; then
    binutils_conf="--enable-targets=i386-pe,x86_64-pe"
  fi
  rm -rf build
  mkdir -p build
  cd build
  ../configure --with-sysroot --prefix="$prefix/$target" --target="$target" --disable-nls --enable-64-bit-bfd --disable-werror $binutils_conf
  make -j$thread_count all
  make install
  cd ../..
  
  cd gcc
  rm -rf build
  mkdir -p build
  cd build
  ../configure --prefix="$prefix/$target" --target="$target" --enable-languages=$languages --disable-multilib --disable-nls --without-headers
  make -j$thread_count all-gcc
  make -j$thread_count all-target-libgcc
  make install-gcc
  make install-target-libgcc
  cd ../..
done

cd ..
rm -rf "$tmpdir"

echo "Done !"
echo "Make sure to add the following to your PATH"
echo
for t in $targets; do
  echo "    $prefix/$t/bin"
done
